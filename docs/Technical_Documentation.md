# MNIC 芯片检测系统技术文档

## 1. 项目概述

### 1.1 项目简介
MNIC（Multi-Node Integrated Circuit）芯片检测系统是一套基于Qt6的音频芯片自动化测试平台，专门用于AIC9628BM等音频芯片的性能检测和质量验证。系统通过UDP网络通信，对多板卡、多芯片进行并行测试，支持实时监控和数据记录。

### 1.2 主要功能
- **芯片状态监控**：实时监控8块板卡共32个芯片的在线状态
- **音频参数测试**：支持不同频率、幅度、持续时间的音频信号生成和测试
- **SINAD测试**：信噪失真比(Signal-to-Noise and Distortion)检测
- **流控管理**：智能数据包发送流控，确保通信稳定性
- **结果统计**：实时统计测试结果，生成详细报告
- **日志记录**：完整的测试过程日志记录和分析

### 1.3 技术特点
- **多线程架构**：采用生产者-消费者模式，支持高并发处理
- **实时通信**：基于UDP协议的低延迟网络通信
- **模块化设计**：高内聚低耦合的组件化架构
- **Qt Model-View**：现代化的GUI框架

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   通信协议层     │
│  (Qt Widgets)   │◄──►│  (Task System)  │◄──►│  (UDP Socket)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   配置管理层     │    │   数据处理层     │    │   硬件设备层     │
│ (Config & File) │    │ (Data Process)  │    │ (MNIC Boards)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 核心组件

#### 2.2.1 任务管理系统 (TaskWZ)
- **worker_manager**: 工作线程池管理器
- **task_wz**: 抽象任务基类
- **专用任务类型**:
  - `task_rcv`: 数据接收任务
  - `task_dispatch`: 数据分发任务
  - `TaskChipStatParsing`: 芯片状态解析任务
  - `TaskDataSend`: 数据发送任务
  - `TaskTestStatistics`: 测试统计任务

#### 2.2.2 网络通信系统 (SocketWZ)
- UDP双向通信协议
- 自动重连机制
- 流控反馈机制
- 数据包完整性校验

#### 2.2.3 数据处理系统 (DataConstruct)
- 音频数据生成
- 寄存器配置构建
- 数据包封装和解析
- 测试参数管理

#### 2.2.4 用户界面系统 (CentralWindow)
- 实时状态显示
- 测试控制面板
- 结果可视化
- 配置管理界面

## 3. 详细设计

### 3.1 数据流架构

```
用户启动测试
    │
    ▼
配置参数加载 ──► 数据构建任务 ──► 发送队列
    │               │              │
    ▼               ▼              ▼
条件设置 ──► 芯片状态解析 ◄── UDP通信 ──► 硬件设备
    │               │              │
    ▼               ▼              ▼
统计分析 ◄── 结果收集 ◄── 数据接收队列
    │
    ▼
界面更新 & 日志记录
```

### 3.2 线程模型

#### 3.2.1 主要线程
1. **UI线程**: 界面更新和用户交互
2. **接收线程** (`task_rcv`): 持续接收UDP数据包
3. **分发线程** (`task_dispatch`): 数据包类型识别和分发
4. **解析线程** (`TaskChipStatParsing`): 芯片状态数据解析
5. **发送线程** (`TaskDataSend`): 测试数据发送和流控管理
6. **统计线程** (`TaskTestStatistics`): 测试结果统计分析

#### 3.2.2 线程同步机制
- **QSemaphore**: 控制线程间的信号通知
- **std::condition_variable**: 精确的线程等待和唤醒
- **std::mutex**: 保护共享资源的并发访问
- **std::atomic**: 无锁的原子操作

### 3.3 数据结构设计

#### 3.3.1 核心数据类型

```cpp
// 音频参数
class ARG {
    double dB;                    // 信号幅度
    unsigned long long Freq;      // 频率(Hz)
    unsigned int Duration;        // 持续时间(s)
};

// 寄存器配置
class ArgRegCFG {
    unsigned char DigitalLeft;    // 数字左声道
    unsigned char DigitalRight;   // 数字右声道
    unsigned char AnalogLeft;     // 模拟左声道
    unsigned char AnalogRight;    // 模拟右声道
};

// 测试条件
class TestCondition {
    Range RangeSINAD;            // SINAD范围
    Range RangeVppPTP;           // 峰峰值范围
    Range RangeVppRMS;           // RMS范围
};
```

#### 3.3.2 通信协议数据帧

```cpp
// 帧头结构
struct FRAME_HEAD {
    unsigned char msgID;          // 消息ID
    unsigned char rev : 4;        // 保留位
    unsigned char ctlFractstop : 1;   // 控制位
    unsigned char ctlFractStrt : 1;   // 控制位
    unsigned char ctlFractMode : 1;   // 控制位
    unsigned char reserved_base : 1;  // 保留位
    unsigned short siglen;        // 信号长度
};

// 芯片状态上报数据
struct UP_MNIC_STA {
    unsigned short timeStamp_8ms;     // 8ms时间戳
    unsigned short free_codec_dac;    // 编解码器DAC空闲数
    unsigned int mnic_online;         // 芯片在线状态位图
    short ds18b20_16b;               // 环境温度
    unsigned short fpga_heat;        // FPGA温度
    // ... 其他字段
    MNICx4_ADC_INFO MNICx4_ADC_INFO_ARR[8]; // 8板芯片ADC信息
};
```

### 3.4 关键算法

#### 3.4.1 流控算法
系统采用自适应流控算法，根据硬件缓冲区状态动态调整发送速率：

```cpp
int waitMs = 8;  // 基础间隔8ms
if (!force8ms) {
    if (fluidVal > 1536) waitMs = 6;      // 缓存充足，加快发送
    else if (fluidVal > 1024) waitMs = 7;  // 缓存适中
    else if (fluidVal < 768) waitMs = 9;   // 缓存不足，减慢发送
}
```

#### 3.4.2 重发检测算法
基于缓存空间变化检测数据包丢失：

```cpp
// 检测缓存从有数据状态变为空状态
if (lastFluidValue < FLUID_SIZE_INDEX0 && currentFluidValue >= FLUID_SIZE_INDEX0) {
    resendCounter.fetch_add(1);  // 触发重发
}
```

#### 3.4.3 统计算法
使用连续有效包计数判断测试结果：

```cpp
bool testPassed = (codecValidCount >= targetCount) && (adpowValidCount >= targetCount);
```

## 4. 关键特性

### 4.1 高性能优化

#### 4.1.1 线程优化
- 关键线程绑定CPU核心
- 设置高优先级线程
- 减少线程切换开销

#### 4.1.2 内存优化
- 预分配接收缓冲区
- 智能指针管理内存
- 减少内存拷贝操作

#### 4.1.3 网络优化
- UDP无连接通信
- 包大小优化（512字节数据包）
- 高精度定时发送

### 4.2 可靠性保证

#### 4.2.1 异常处理
- 网络断线检测和重连
- 线程异常捕获和恢复
- 数据校验和错误重传

#### 4.2.2 状态监控
- 实时芯片在线状态检测
- 温度监控和报警
- 系统性能监控

### 4.3 可扩展性

#### 4.3.1 模块化设计
- 插件式任务扩展
- 配置文件动态加载
- 协议栈可替换

#### 4.3.2 配置管理
- INI文件配置
- 运行时参数调整
- 测试用例管理

## 5. 部署和使用

### 5.1 编译环境
- **操作系统**: Windows 10/11
- **编译器**: Visual Studio 2022 (MSVC)
- **Qt版本**: Qt 6.6.3 (静态编译)
- **CMake**: 3.31.6+
- **C++标准**: C++17

### 5.2 构建步骤

```bash
# 配置CMake
cmake.exe -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=TRUE \
  -S. -Bbuild -G "Visual Studio 17 2022" -T host=x64 -A x64

# 编译项目
cmake.exe --build build --config Release --target ALL_BUILD -j 18
```

### 5.3 运行环境

#### 5.3.1 硬件要求
- **处理器**: Intel Core i5 或 AMD Ryzen 5 以上
- **内存**: 8GB RAM 以上
- **网络**: 千兆以太网接口
- **测试设备**: MNIC测试板卡（最多8块）

#### 5.3.2 网络配置
- **本机IP**: 配置为与测试设备同网段
- **设备IP**: 测试设备的IP地址
- **端口**: UDP通信端口（可配置）

### 5.4 基本使用流程

1. **启动程序**：运行MNIC.exe
2. **网络配置**：菜单→配置→网口配置
3. **添加参数**：菜单→文件→添加测试参数
4. **SINAD配置**：菜单→配置→SINAD配置
5. **开始测试**：主界面→设置测试次数→开始测试
6. **查看结果**：实时监控界面状态和结果
7. **查看日志**：点击"打开日志"查看详细测试记录

## 6. 日志和调试

### 6.1 日志系统

#### 6.1.1 日志类型
- **系统日志**: 程序运行状态和错误信息
- **网络日志**: UDP通信数据包记录
- **测试日志**: 详细的测试过程和结果
- **性能日志**: 系统性能指标和优化数据

#### 6.1.2 日志文件
```
LOG/
├── LogTaskDataSend.log      # 数据发送日志
├── LogTaskRcv.txt          # 数据接收日志
├── LogTask0X28Parsing.txt  # 芯片状态解析日志
├── LogUpRecord.log         # 上报记录日志
├── LogSeRecord_YYYYMMDD_HHMMSS.log  # 简要测试记录
└── LogUpRecordProcessed_YYYYMMDD_HHMMSS.log  # 处理后的日志
```

### 6.2 调试功能

#### 6.2.1 调试开关
```cpp
#define TASK_DATA_SEND_DBG    // 发送任务调试
#define TASK_RCV_DBG          // 接收任务调试  
#define CENTRAL_WIDGET_DBG    // 主界面调试
#define MNIC_DBG              // 主程序调试
```

#### 6.2.2 性能监控
- 网络包收发统计
- 线程响应时间监控
- 内存使用情况
- CPU使用率监控

## 7. 故障排除

### 7.1 常见问题

#### 7.1.1 网络连接问题
**症状**: 界面显示设备离线，无法通信
**解决方案**:
1. 检查网络线缆连接
2. 确认本机和设备IP地址配置
3. 检查防火墙设置
4. 验证UDP端口是否被占用

#### 7.1.2 芯片检测异常
**症状**: 芯片显示离线或测试结果异常
**解决方案**:
1. 检查测试板卡电源和连接
2. 确认芯片型号和固件版本
3. 调整SINAD阈值设置
4. 检查测试参数配置

#### 7.1.3 性能问题
**症状**: 测试速度慢，界面响应慢
**解决方案**:
1. 关闭不必要的调试日志
2. 调整线程优先级
3. 优化网络参数
4. 检查系统资源使用情况

### 7.2 日志分析

#### 7.2.1 错误代码
- **Socket Error**: 网络通信错误
- **Checksum Error**: 数据校验失败
- **Timeout Error**: 通信超时
- **Memory Error**: 内存分配失败

#### 7.2.2 分析工具
程序内置日志处理器，可以自动分析和整理测试日志：
```cpp
LPWZ::LogProcessor().processLog(inputFile, outputFile);
```

## 8. 维护和扩展

### 8.1 代码维护

#### 8.1.1 代码规范
- 使用匈牙利命名法和驼峰命名法
- 详细的注释说明
- 模块化的代码组织
- 统一的错误处理机制

#### 8.1.2 版本控制
- 使用Git进行版本管理
- 详细的提交信息
- 分支管理策略
- 发布版本标签

### 8.2 功能扩展

#### 8.2.1 新增测试项目
1. 在`TestCondition`类中添加新的测试条件
2. 修改数据包解析逻辑
3. 更新统计算法
4. 调整用户界面显示

#### 8.2.2 支持新芯片
1. 更新通信协议定义
2. 修改数据结构
3. 调整测试参数范围
4. 更新配置文件格式

### 8.3 性能优化建议

#### 8.3.1 网络优化
- 考虑使用零拷贝技术
- 实现更智能的流控算法
- 支持多播和广播
- 添加网络拥塞控制

#### 8.3.2 界面优化
- 使用异步更新减少界面阻塞
- 实现数据虚拟化提高显示性能
- 添加图表显示功能
- 支持自定义界面布局

## 9. 技术规格

### 9.1 系统指标

| 指标项 | 规格 | 备注 |
|--------|------|------|
| 支持板卡数 | 8块 | 每块4个芯片 |
| 并发芯片数 | 32个 | 同时测试 |
| 网络延迟 | <10ms | UDP通信 |
| 测试精度 | ±0.1dB | SINAD测试 |
| 数据包大小 | 512字节 | 音频采样点 |
| 发送频率 | 8ms间隔 | 可动态调整 |
| 内存占用 | <100MB | 正常运行状态 |
| CPU占用 | <20% | 测试运行时 |

### 9.2 支持的测试参数

| 参数类型 | 范围 | 单位 | 精度 |
|----------|------|------|------|
| 信号幅度 | -100~100 | dB | 0.1dB |
| 测试频率 | 20~20000 | Hz | 1Hz |
| 持续时间 | 1~100 | s | 1s |
| SINAD阈值 | 0~100 | dB | 0.1dB |
| 温度监控 | -40~125 | ℃ | 0.1℃ |

## 10. 联系信息

### 10.1 技术支持
- **开发团队**: MNIC项目组
- **维护状态**: 活跃开发中
- **最后更新**: 2025年8月

### 10.2 文档版本
- **文档版本**: v1.0
- **适用软件版本**: MNIC v2.5+
- **创建日期**: 2024年12月
- **更新周期**: 随软件版本更新

---

**注意**: 本文档基于当前代码状态生成，实际功能可能因版本更新而有所变化。使用前请确认软件版本匹配性。